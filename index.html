<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>‚öîÔ∏è Tempo Clan Wars</title>
<link rel="icon" href="data:,">

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

<style>
body{
  margin:0;
  min-height:100vh;
  font-family:Segoe UI,Arial;
  color:white;
  background:
    linear-gradient(rgba(0,0,0,.75),rgba(0,0,0,.9)),
    url("https://images.unsplash.com/photo-1519681393784-d120267933ba");
  background-size:cover;
  display:flex;
  justify-content:center;
  align-items:center;
}
.card{
  width:440px;
  padding:32px;
  background:rgba(20,20,20,.65);
  backdrop-filter:blur(16px);
  border-radius:18px;
  border:1px solid rgba(255,255,255,.15);
  text-align:center;
  box-shadow:0 0 40px rgba(0,0,0,.8);
}
.score{
  display:flex;
  justify-content:space-between;
  font-size:1.5em;
  margin:20px 0;
}
.red{color:#ff5555;text-shadow:0 0 10px red;}
.blue{color:#4da6ff;text-shadow:0 0 10px #4da6ff;}
.progress{
  background:#333;
  height:10px;
  border-radius:5px;
  overflow:hidden;
}
.progress-fill{
  height:100%;
  background:linear-gradient(90deg,#00ff99,#00ffaa);
  width:0%;
}
button{
  width:100%;
  padding:14px;
  margin-top:10px;
  border:none;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
}
#connectBtn{background:white;color:black;}
.btn-red{background:#ff3333;color:white;}
.btn-blue{background:#0066ff;color:white;}
.hidden{display:none;}
.badge{
  border:2px dashed #aaa;
  padding:16px;
  margin-top:16px;
  border-radius:14px;
}
.security-box{
  margin-top:15px;
  font-size:0.85em;
  color:#aaa;
  border-top:1px solid #333;
  padding-top:10px;
  text-align:left;
}
.links{
  margin-top:10px;
  font-size:0.85em;
}
.links a{color:#6cf;text-decoration:none;}
#audioBtn{
  position:fixed;
  bottom:20px;
  right:20px;
  background:rgba(0,0,0,.7);
  border:none;
  border-radius:50%;
  width:48px;
  height:48px;
  font-size:22px;
  cursor:pointer;
  color:white;
}
</style>
</head>

<body>

<div class="card">
  <h1>‚öîÔ∏è Tempo Clan Wars</h1>
  <small id="seasonText">Loading season...</small>

  <div style="margin-top:8px;font-size:.9em;color:#7f7;">
    Non-Custodial ‚Ä¢ No Approvals ‚Ä¢ Open-Source
  </div>

  <div class="score">
    <div class="red">üî¥ <span id="red">0</span></div>
    <div class="blue">üîµ <span id="blue">0</span></div>
  </div>

  <div class="progress">
    <div id="bar" class="progress-fill"></div>
  </div>

  <p id="slot">Loading...</p>
  <p id="countdown"></p>

  <!-- READ-ONLY INFO -->
  <small style="color:#aaa">
    You can view scores without connecting wallet.
  </small>

  <button id="connectBtn">CONNECT WALLET</button>

  <div id="join" class="hidden">
    <small style="color:#aaa">
      Only 1 transaction required. Gas shown in MetaMask.
    </small>
    <button class="btn-red" onclick="join(1)">JOIN RED üî¥</button>
    <button class="btn-blue" onclick="join(2)">JOIN BLUE üîµ</button>
  </div>

  <div id="badge" class="badge hidden">
    <h2 id="faction"></h2>
    <h1 id="cid"></h1>
    <small>Genesis Citizen</small>
  </div>

  <div class="security-box">
    üîí <b>Security Notice</b><br>
    ‚Ä¢ We never ask for private keys<br>
    ‚Ä¢ No token approvals required<br>
    ‚Ä¢ One transaction only<br>
    ‚Ä¢ You can reject any transaction in MetaMask
  </div>

  <div class="links">
    <a href="https://explore.tempo.xyz/address/0x8a9Fc7E1cdcF13f66b97658DA49232449F762994" target="_blank">
      View Contract
    </a>
    ‚Ä¢
    <a href="https://github.com/alifauliaxd/tempo-wars" target="_blank">
      View Source
    </a>
  </div>

  <p id="status"></p>
</div>

<footer class="footer">
  Built by 
  <a href="https://twitter.com/kaiclydex_" target="_blank" rel="noopener">
    @kaiclydex_
  </a>
  ‚öîÔ∏è
</footer>

<audio id="bgMusic" src="music.mp3" loop></audio>
<audio id="joinSound" src="sound.wav"></audio>
<button id="audioBtn">üîá</button>

<script>
/* ================= CONFIG ================= */

const CONTRACT_ADDRESS =
 "0x8a9Fc7E1cdcF13f66b97658DA49232449F762994";

const TEMPO_CHAIN = {
  chainId: "0xa5bd", // 42429
  chainName: "Tempo Testnet (Andantino)",
  nativeCurrency: { name:"USD", symbol:"USD", decimals:18 },
  rpcUrls: ["https://rpc.testnet.tempo.xyz"],
  blockExplorerUrls: ["https://explore.tempo.xyz"]
};

const ABI = [
  "function joinFaction(uint8)",
  "function getMyStatus(address) view returns(uint256,uint8,uint256)",
  "function getScore() view returns(uint256,uint256)",
  "function getSeasonInfo() view returns(uint256,uint256,uint256,uint256)"
];

/* ================= PROVIDERS ================= */

// READ-ONLY (no wallet)
const READ_PROVIDER =
  new ethers.providers.JsonRpcProvider(
    "https://rpc.testnet.tempo.xyz"
  );

const readContract =
  new ethers.Contract(
    CONTRACT_ADDRESS,
    ABI,
    READ_PROVIDER
  );

// SIGNER (wallet)
let provider, signer, contract, user;

/* ================= STATE ================= */

let seasonEnd = 0;
let countdownInterval;

const bgMusic = document.getElementById("bgMusic");
const joinSound = document.getElementById("joinSound");
const audioBtn = document.getElementById("audioBtn");
let musicOn = false;

/* ================= AUDIO ================= */

audioBtn.onclick = () => {
  if (!musicOn) {
    bgMusic.volume = 0.25;
    bgMusic.play();
    audioBtn.innerText = "üîä";
    musicOn = true;
  } else {
    bgMusic.pause();
    audioBtn.innerText = "üîá";
    musicOn = false;
  }
};

/* ================= READ-ONLY LOAD (AUTO) ================= */

load();
setInterval(load,15000);

/* ================= CONNECT WALLET ================= */

document.getElementById("connectBtn").onclick = connect;

async function connect(){
  if (!window.ethereum) {
    alert("Please install MetaMask");
    return;
  }

  await ethereum.request({ method:"eth_requestAccounts" });

  try{
    await ethereum.request({
      method:"wallet_switchEthereumChain",
      params:[{ chainId:TEMPO_CHAIN.chainId }]
    });
  }catch{
    await ethereum.request({
      method:"wallet_addEthereumChain",
      params:[TEMPO_CHAIN]
    });
  }

  provider = new ethers.providers.Web3Provider(window.ethereum);
  signer = provider.getSigner();

  const net = await provider.getNetwork();
  if (net.chainId !== 42429) {
    alert("Wrong network. Use Tempo Testnet.");
    return;
  }

  user = await signer.getAddress();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

  document.getElementById("connectBtn").classList.add("hidden");

  bgMusic.volume = 0.25;
  bgMusic.play();
  audioBtn.innerText = "üîä";
  musicOn = true;

  load(); // upgrade to signed mode
}

/* ================= LOAD DATA ================= */

async function load(){
  const [red, blue] = await readContract.getScore();
  document.getElementById("red").innerText = red;
  document.getElementById("blue").innerText = blue;

  const info = await readContract.getSeasonInfo();
  const seasonId = info[0];
  const joined = info[1];
  const max = info[2];
  seasonEnd = info[3];

  document.getElementById("seasonText").innerText =
    `Season ${seasonId} ‚Äì Genesis`;

  document.getElementById("slot").innerText =
    `Citizens ${joined} / ${max}`;

  document.getElementById("bar").style.width =
    (joined / max * 100) + "%";

  startCountdown();

  if (user) checkStatus();
}

/* ================= COUNTDOWN ================= */

function startCountdown(){
  clearInterval(countdownInterval);
  countdownInterval = setInterval(()=>{
    const now = Math.floor(Date.now()/1000);
    const diff = seasonEnd - now;

    document.getElementById("countdown").innerText =
      diff <= 0
        ? "Season Ended"
        : `Ends in ${Math.floor(diff/86400)}d ${Math.floor(diff%86400/3600)}h ${Math.floor(diff%3600/60)}m`;
  },1000);
}

/* ================= STATUS ================= */

async function checkStatus(){
  const s = await contract.getMyStatus(user);

  if (s[0] > 0) {
    document.getElementById("join").classList.add("hidden");
    document.getElementById("badge").classList.remove("hidden");
    document.getElementById("cid").innerText = "#" + s[0];
    document.getElementById("faction").innerText =
      s[1] == 1 ? "RED üî¥" : "BLUE üîµ";
  } else {
    document.getElementById("join").classList.remove("hidden");
  }
}

/* ================= JOIN ================= */

async function join(f){
  joinSound.play();
  document.getElementById("status").innerText = "Joining...";
  const tx = await contract.joinFaction(f);
  await tx.wait();
  document.getElementById("status").innerText = "Welcome to the war ‚öîÔ∏è";
  load();
}
</script>

</body>
</html>